<!-- Generated by SpecStory, Markdown v2.1.0 -->

# 2026-01-23 09:04:17Z

<!-- Codex CLI Session 019bea18-cb38-7060-a558-6e979b224c74 (2026-01-23 09:04:17Z) -->

_**User (2026-01-23 09:04:17Z)**_

## 概述
  在 CodeMirror 6 编辑器中实现 slash menu（斜杠菜单），当用户在 WYSIWYG 模式下输入 `/` 时弹出命令菜单，支持搜索过滤和键盘导航。

  ## 文件结构

  ```
  src/components/editor/slash-menu/
  ├── index.ts                    # 公共导出
  ├── slash-menu.tsx              # Vue TSX 组件
  ├── slash-menu.css              # 样式
  ├── slash-menu-extension.ts     # CodeMirror 扩展（监听 / 输入）
  ├── slash-menu-items.ts         # 命令项定义
  └── use-slash-menu.ts           # 状态管理 composable
  ```

  ## 实现步骤

  ### 1. 创建命令项定义 (slash-menu-items.ts)

  定义菜单项，分组显示：

  | 分组 | 命令 |
  |------|------|
  | 标题 | H1-H6 |
  | 文本 | 粗体、斜体、删除线、行内代码 |
  | 列表 | 无序列表、有序列表、任务列表 |
  | 块 | 代码块、引用、分隔线 |
  | 媒体 | 链接、图片、表格、数学公式 |

  复用 `markdown-commands.ts` 中的命令实现。

  ### 2. 创建 CodeMirror 扩展 (slash-menu-extension.ts)

  - 使用 `StateField` 跟踪菜单状态（是否激活、触发位置、查询字符串）
  - 使用 `StateEffect` 控制菜单开关
  - 监听输入事件，检测 `/` 字符
  - 仅在行首或空白后触发

  ### 3. 创建状态管理 (use-slash-menu.ts)

  ```typescript
  export function useSlashMenu(editorView: Ref<EditorView | undefined>) {
  // 菜单可见状态
  // 菜单位置（使用 view.coordsAtPos）
  // 查询字符串
  // 过滤逻辑（Fuse.js 模糊搜索）
  // 键盘导航（activeIndex）
  // 选择处理（执行命令并清理 / 触发符）
  }
  ```

  ### 4. 创建 Vue 组件 (slash-menu.tsx)

  - `Teleport to="body"` 渲染到 body
  - `Transition` 实现平滑动画
  - `fixed` 定位 + inline style
  - 分组显示命令项
  - 键盘导航支持（↑↓ Enter Escape）
  - 玻璃态样式（glass morphism）

  ### 5. 创建样式 (slash-menu.css)

  遵循项目规范：
  - `neutral` 色系（非 gray）
  - 标准字号（text-sm, text-xs）
  - dark mode 支持
  - glass morphism 效果

  ### 6. 在 extension.ts 中注册

  ```typescript
  const extensionMap = {
  // ... 现有
  slashMenu: new Compartment(),
  }
  ```

  ### 7. 在 codemirror.tsx 中集成

  ```tsx
  // 导入
  import { SlashMenu } from '../slash-menu'
  import { useSlashMenu } from '../slash-menu/use-slash-menu'

  // 在 watch renderMode 中添加 slashMenu 扩展
  // 在模板中添加 <SlashMenu /> 组件（仅 WYSIWYG 模式）
  ```

  ## 关键技术点

  ### 触发逻辑
  - 检测 `/` 输入位置：行首 或 前一个字符是空白
  - 输入后续字符作为搜索查询
  - **代码块内不触发**：复用 `wysiwyg-codeblock.ts` 中的 `isLineInsideCodeBlock` 函数检测

  ### 关闭条件
  - `Escape` 键
  - 点击外部
  - 光标移出触发区域
  - 选择命令项

  ### 命令执行
  1. 删除 `/` 和查询文本
  2. 插入对应 markdown 语法
  3. 聚焦编辑器
  4. 关闭菜单

  ### 位置计算
  ```typescript
  const coords = view.coordsAtPos(triggerPos)
  position = { x: coords.left, y: coords.bottom + 4 }
  ```

  ## 修改文件清单

  | 文件 | 操作 |
  |------|------|
  | `src/components/editor/slash-menu/index.ts` | 新建 |
  | `src/components/editor/slash-menu/slash-menu.tsx` | 新建 |
  | `src/components/editor/slash-menu/slash-menu.css` | 新建 |
  | `src/components/editor/slash-menu/slash-menu-extension.ts` | 新建 |
  | `src/components/editor/slash-menu/slash-menu-items.ts` | 新建 |
  | `src/components/editor/slash-menu/use-slash-menu.ts` | 新建 |
  | `src/components/editor/codemirror/extension.ts` | 修改（添加 slashMenu Compartment） |
  | `src/components/editor/codemirror/codemirror.tsx` | 修改（集成 SlashMenu 组件） |

  ## 验证方式

  1. 运行 `pnpm dev` 启动开发服务器
  2. 打开文章/笔记编辑页面
  3. 确保编辑器处于 WYSIWYG 模式
  4. 测试场景：
  - 行首输入 `/` → 菜单弹出
  - 空格后输入 `/` → 菜单弹出
  - 输入查询字符过滤命令
  - ↑↓ 键导航
  - Enter 选择命令
  - Escape 关闭菜单
  - 点击外部关闭菜单
  5. 运行 `pnpm tsc --noEmit` 验证类型

_**User (2026-01-23 09:04:32Z)**_

## 概述
  在 CodeMirror 6 编辑器中实现 slash menu（斜杠菜单），当用户在 WYSIWYG 模式下输入 `/` 时弹出命令菜单，支持搜索过滤和键盘导航。

  ## 文件结构

  ```
  src/components/editor/slash-menu/
  ├── index.ts                    # 公共导出
  ├── slash-menu.tsx              # Vue TSX 组件
  ├── slash-menu.css              # 样式
  ├── slash-menu-extension.ts     # CodeMirror 扩展（监听 / 输入）
  ├── slash-menu-items.ts         # 命令项定义
  └── use-slash-menu.ts           # 状态管理 composable
  ```

  ## 实现步骤

  ### 1. 创建命令项定义 (slash-menu-items.ts)

  定义菜单项，分组显示：

  | 分组 | 命令 |
  |------|------|
  | 标题 | H1-H6 |
  | 文本 | 粗体、斜体、删除线、行内代码 |
  | 列表 | 无序列表、有序列表、任务列表 |
  | 块 | 代码块、引用、分隔线 |
  | 媒体 | 链接、图片、表格、数学公式 |

  复用 `markdown-commands.ts` 中的命令实现。

  ### 2. 创建 CodeMirror 扩展 (slash-menu-extension.ts)

  - 使用 `StateField` 跟踪菜单状态（是否激活、触发位置、查询字符串）
  - 使用 `StateEffect` 控制菜单开关
  - 监听输入事件，检测 `/` 字符
  - 仅在行首或空白后触发

  ### 3. 创建状态管理 (use-slash-menu.ts)

  ```typescript
  export function useSlashMenu(editorView: Ref<EditorView | undefined>) {
  // 菜单可见状态
  // 菜单位置（使用 view.coordsAtPos）
  // 查询字符串
  // 过滤逻辑（Fuse.js 模糊搜索）
  // 键盘导航（activeIndex）
  // 选择处理（执行命令并清理 / 触发符）
  }
  ```

  ### 4. 创建 Vue 组件 (slash-menu.tsx)

  - `Teleport to="body"` 渲染到 body
  - `Transition` 实现平滑动画
  - `fixed` 定位 + inline style
  - 分组显示命令项
  - 键盘导航支持（↑↓ Enter Escape）
  - 玻璃态样式（glass morphism）

  ### 5. 创建样式 (slash-menu.css)

  遵循项目规范：
  - `neutral` 色系（非 gray）
  - 标准字号（text-sm, text-xs）
  - dark mode 支持
  - glass morphism 效果

  ### 6. 在 extension.ts 中注册

  ```typescript
  const extensionMap = {
  // ... 现有
  slashMenu: new Compartment(),
  }
  ```

  ### 7. 在 codemirror.tsx 中集成

  ```tsx
  // 导入
  import { SlashMenu } from '../slash-menu'
  import { useSlashMenu } from '../slash-menu/use-slash-menu'

  // 在 watch renderMode 中添加 slashMenu 扩展
  // 在模板中添加 <SlashMenu /> 组件（仅 WYSIWYG 模式）
  ```

  ## 关键技术点

  ### 触发逻辑
  - 检测 `/` 输入位置：行首 或 前一个字符是空白
  - 输入后续字符作为搜索查询
  - **代码块内不触发**：复用 `wysiwyg-codeblock.ts` 中的 `isLineInsideCodeBlock` 函数检测

  ### 关闭条件
  - `Escape` 键
  - 点击外部
  - 光标移出触发区域
  - 选择命令项

  ### 命令执行
  1. 删除 `/` 和查询文本
  2. 插入对应 markdown 语法
  3. 聚焦编辑器
  4. 关闭菜单

  ### 位置计算
  ```typescript
  const coords = view.coordsAtPos(triggerPos)
  position = { x: coords.left, y: coords.bottom + 4 }
  ```

  ## 修改文件清单

  | 文件 | 操作 |
  |------|------|
  | `src/components/editor/slash-menu/index.ts` | 新建 |
  | `src/components/editor/slash-menu/slash-menu.tsx` | 新建 |
  | `src/components/editor/slash-menu/slash-menu.css` | 新建 |
  | `src/components/editor/slash-menu/slash-menu-extension.ts` | 新建 |
  | `src/components/editor/slash-menu/slash-menu-items.ts` | 新建 |
  | `src/components/editor/slash-menu/use-slash-menu.ts` | 新建 |
  | `src/components/editor/codemirror/extension.ts` | 修改（添加 slashMenu Compartment） |
  | `src/components/editor/codemirror/codemirror.tsx` | 修改（集成 SlashMenu 组件） |

  ## 验证方式

  1. 运行 `pnpm dev` 启动开发服务器
  2. 打开文章/笔记编辑页面
  3. 确保编辑器处于 WYSIWYG 模式
  4. 测试场景：
  - 行首输入 `/` → 菜单弹出
  - 空格后输入 `/` → 菜单弹出
  - 输入查询字符过滤命令
  - ↑↓ 键导航
  - Enter 选择命令
  - Escape 关闭菜单
  - 点击外部关闭菜单
  5. 运行 `pnpm tsc --noEmit` 验证类型
