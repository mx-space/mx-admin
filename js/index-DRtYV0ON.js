import{d as E,a as f,b5 as Y,c as e,D,v as Z,b6 as o,V as g,Q as j,s as B,B as b,g as i,p as z,ap as G,Z as J,Y as K,b as W,b7 as S,w as M,av as X,at as ee,F as O,H as q,A as ae,b8 as te,b9 as ue,C as le,R as p,y as ne,am as se,aa as re,an as x,k as A,a0 as N,ao as ie,a1 as oe,i as P,j as de,N as ce,n as ve,ab as pe}from"./index-D5BxuJyQ.js";import{o as fe}from"./omit-BLIy1hQE.js";const U={Audit:"待审核",Pass:"通过",Outdate:"过时",Banned:"屏蔽",Reject:"拒绝"},me="https://fastly.jsdelivr.net/gh/mx-space/mx-admin@gh-pages/assets/fallback-BjFffESB.jpg";function _(u){return typeof u=="function"||Object.prototype.toString.call(u)==="[object Object]"&&!Z(u)}const L=E(u=>{const m=f(),c=f(!1),s=Y(m,r=>{r[0].isIntersecting&&(c.value=!0,s.stop())});return()=>{let r,n;return e("div",{ref:m},[u.avatar?c.value?e(D,{src:u.avatar,round:!0,onError:C=>{C.target.src=me}},null):e(D,{round:!0},_(r=u.name.charAt(0))?r:{default:()=>[r]}):e(D,{round:!0},_(n=u.name.charAt(0))?n:{default:()=>[n]})])}});L.props=["avatar","name"];const ye=E({props:{onCallback:{type:Function,required:!0}},setup(u){const m=f(""),c=f(o.Pass),s=Object.entries(U).filter(([n])=>n!=="Audit").map(([n,C])=>({value:o[n],key:n,label:C})),r=()=>{u.onCallback(c.value,m.value)};return()=>e(z,{class:"mt-6"},{default:()=>[e(g,{label:"状态"},{default:()=>[e(j,{value:c.value,onUpdateValue:n=>c.value=n,options:s},null)]}),e(g,{label:"原因"},{default:()=>[e(B,{type:"textarea",value:m.value,onUpdateValue:n=>m.value=n,placeholder:"请输入原因",maxlength:200,autosize:{maxRows:4,minRows:2}},null)]}),e("div",{class:"flex justify-end"},[e(b,{round:!0,type:"primary",onClick:r},{default:()=>[i("发送")]})])]})}}),ge=E({props:{url:String,errorMessage:String,status:[String,Number]},setup(u){return()=>e("div",{class:"flex items-center space-x-2"},[e("a",{target:"_blank",href:u.url,rel:"noreferrer"},[u.url]),typeof u.status<"u"&&(u.errorMessage?e(G,null,{trigger(){return e("div",{class:"h-2 w-2 rounded-full bg-red-400"},null)},default(){return u.errorMessage}}):e("div",{class:"h-2 w-2 rounded-full bg-green-300"},null))])}}),ke=E({setup(){const u=J(),m=ne(),c=f(u.query.state??o.Pass),{data:s,fetchDataFn:r,pager:n,loading:C}=K((a,l)=>async(d=u.query.page||1,h=50)=>{const F=u.query.state??o.Pass,V=await p.api.links.get({params:{page:d,size:h,state:F|0}});a.value=V.data,l.value=V.pagination}),v=W(),w=()=>({avatar:"",name:"",type:S.Friend,url:"",id:null,description:"",state:o.Pass}),k=f(!1),t=f(w());M(()=>u.query.state,async a=>{await r()}),M(()=>u.query.page,async a=>{await r()},{immediate:!0});const y=f({}),I=async()=>{const a=await p.api.links.state.get();y.value=a};X(()=>{I()});const $=async()=>{const a=t.value.id;if(a){const l=await p.api.links(a).put({data:fe(t.value,["id","created","hide"])}),d=s.value.findIndex(h=>h.id==a);l.state!=c.value?(s.value.splice(d,1),I()):s.value[d]={...s.value[d],...pe(t.value)}}else{const{data:l}=await p.api.links.post({data:{...t.value}});s.value.unshift(l)}v.success("操作成功"),k.value=!1,t.value=w()},R=f(),H=async()=>{const a=v.loading("检查中",{duration:2e5});try{const l=await p.api.links.health.get({timeout:2e5});R.value=Object.entries(l).reduce((d,[h,F])=>({...d,[h.toLowerCase()]:F}),{}),v.success("检查完成")}catch(l){console.error(l)}finally{requestAnimationFrame(()=>{a.destroy()})}},Q=async()=>{const a=v.loading("迁移中",{duration:2e5});try{await p.api.links.avatar.migrate.post({timeout:2e5}),v.success("迁移完成"),await r()}catch(l){console.error(l),v.error("迁移失败")}finally{requestAnimationFrame(()=>{a.destroy()})}},T=ee();return()=>e(le,{actionsElement:e(O,null,[e(q,{icon:e(ae,null,null),variant:"primary",onClick:()=>{t.value=w(),k.value=!0}},null),e(q,{icon:e(te,null,null),variant:"info",onClick:H,name:"检查友链可用性"},null),e(q,{icon:e(ue,null,null),variant:"info",onClick:Q,name:"迁移头像"},null)])},{default:()=>[e(se,{class:"min-h-[30px]",size:"medium",value:c.value,onUpdateValue:a=>{c.value=a,m.replace({name:re.Friend,query:{state:a}})}},{default:()=>[e(x,{name:o.Pass,tab:"朋友们"},null),e(x,{name:o.Audit,tab:()=>e(A,{value:y.value.audit,processing:!0},{default:()=>[e(N,null,{default:()=>[i("待审核")]})]})},null),e(x,{name:o.Outdate,tab:()=>e(A,{value:y.value.outdate,type:"info"},{default:()=>[e(N,null,{default:()=>[i("过时的")]})]})},null),e(x,{name:o.Reject,tab:()=>e(A,{value:y.value.reject,type:"warning"},{default:()=>[e(N,null,{default:()=>[i("已拒绝")]})]})},null),e(x,{name:o.Banned,tab:()=>e(A,{value:y.value.banned,type:"error"},{default:()=>[e(N,null,{default:()=>[i("封禁的")]})]})},null)]}),e(ie,{loading:C.value,data:s,nTableProps:{maxHeight:"calc(100vh - 22rem)"},columns:[{title:"头像",key:"avatar",width:80,render(a){return e(L,{name:a.name,avatar:a.avatar},null)}},{title:"名称",key:"name",render(a){return e("a",{target:"_blank",href:a.url,rel:"noreferrer"},[a.name])}},{title:"描述",key:"description",width:250,ellipsis:{lineClamp:2,tooltip:!0}},{title:"网址",key:"url",render(a){const l=R.value?.[a.id];return e(ge,{url:a.url,errorMessage:l?.message,status:l?.status},null)}},{title:"类型",key:"type",width:80,render(a){return["朋友","收藏"][a.type|0]}},{title:"对方邮箱",key:"email",render(a){return e("a",{href:`mailto:${a.email}`},[a.email])}},{title:"结识时间",key:"created",width:80,render(a){return e(oe,{time:a.created},null)}},{width:150,title:"操作",fixed:"right",key:"action",render(a){return e(P,{wrap:!1},{default:()=>[a.state==o.Audit&&e(O,null,[e(b,{quaternary:!0,size:"tiny",type:"primary",onClick:async()=>{await p.api.links.audit(a.id).patch(),v.success(`通过了来自${a.name}的友链邀请`);const l=s.value.findIndex(d=>d.id==a.id);s.value.splice(l,1),y.value.audit--}},{default:()=>[i("通过")]}),e(b,{quaternary:!0,size:"tiny",type:"info",onClick:async()=>{T.create({title:"发送友链结果",closeOnEsc:!0,closable:!0,content:()=>e(ye,{onCallback:async(l,d)=>{await p.api.links.audit.reason(a.id).post({data:{state:l,reason:d}}),v.success(`已发送友链结果给「${a.name}」`);const h=s.value.findIndex(F=>F.id==a.id);s.value.splice(h,1),y.value.audit--,T.destroyAll()}},null)})}},{default:()=>[i("理由")]})]),e(b,{quaternary:!0,size:"tiny",type:"info",onClick:l=>{k.value=!0,t.value={...a}}},{default:()=>[i("编辑")]}),e(de,{positiveText:"取消",negativeText:"删除",onNegativeClick:async()=>{await p.api.links(a.id).delete(),v.success("删除成功"),await r(n.value.currentPage),a.state==o.Audit&&y.value.audit--}},{trigger:()=>e(b,{quaternary:!0,type:"error",size:"tiny"},{default:()=>[i("移除")]}),default:()=>e("span",{class:"max-w-48"},[i("确定要删除友链 "),a.name,i(" ?")])})]})}}],onFetchData:r,pager:n},null),e(ce,{transformOrigin:"center",show:k.value,onUpdateShow:a=>void(k.value=a)},{default:()=>[e(ve,{style:"width: 500px;max-width: 90vw",headerStyle:{textAlign:"center"},title:t.value.id?`编辑: ${t.value.name}`:"新增"},{default:()=>[e(z,null,{default:()=>[e(g,{label:"名字",required:!0},{default:()=>[e(B,{autofocus:!0,value:t.value.name,onInput:a=>void(t.value.name=a)},null)]}),e(g,{label:"头像"},{default:()=>[e(B,{autofocus:!0,value:t.value.avatar,onInput:a=>void(t.value.avatar=a)},null)]}),e(g,{label:"网址",required:!0},{default:()=>[e(B,{autofocus:!0,value:t.value.url,onInput:a=>void(t.value.url=a)},null)]}),e(g,{label:"描述"},{default:()=>[e(B,{autofocus:!0,value:t.value.description,onInput:a=>void(t.value.description=a)},null)]}),e(g,{label:"类型"},{default:()=>[e(j,{placeholder:"选择类型",options:[{label:"朋友",value:S.Friend},{label:"收藏",value:S.Collection}],value:t.value.type,onUpdateValue:a=>void(t.value.type=a|0)},null)]}),t.value.id&&e(g,{label:"状态"},{default:()=>[e(j,{placeholder:"选择状态",options:Object.entries(U).map(([a,l])=>({label:l,value:o[a]})),value:t.value.state,onUpdateValue:a=>void(t.value.state=a|0)},null)]})]}),e("div",{class:"text-right"},[e(P,{size:12,align:"center",inline:!0},{default:()=>[e(b,{type:"primary",onClick:$,round:!0},{default:()=>[i("确定")]}),e(b,{onClick:()=>{k.value=!1,t.value=w()},round:!0},{default:()=>[i("取消")]})]})])]})]})]})}});export{ke as default};
