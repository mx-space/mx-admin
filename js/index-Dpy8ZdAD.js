import{ar as m,d as f,A as P,u as _,a as w,g as E,r as F,h as R,w as Y,i as e,cu as I,b8 as K,X as Q,j as i,J as G,B as N,P as B,N as g,M as $,bX as q,m as H,n as X,T as J,V as Z,p as ee,F as te,aw as ae,q as y,b$ as le,I as ue,x as se,b2 as x,z as O,cv as ne,aQ as T,cw as re,cx as oe,bS as ie,H as z,bt as de,Y as ce}from"./index-R5yA_R4y.js";import{C as be}from"./chevron-right-CcNMHgi7.js";import{P as ve}from"./play-w9XLB0Fh.js";const k={getList:()=>m.get("/webhooks"),getEvents:()=>m.get("/webhooks/events"),create:t=>m.post("/webhooks",{data:t}),update:(t,u)=>m.patch(`/webhooks/${t}`,{data:u}),delete:t=>m.delete(`/webhooks/${t}`),test:(t,u)=>m.post(`/webhooks/${t}/test`,{data:{event:u}})},b={TO_VISITOR:1,TO_ADMIN:2,TO_SYSTEM:4,ALL:7};function W(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!ae(t)}const A=f({props:{title:{type:String,required:!0}},setup(t,{slots:u}){return()=>e("div",{class:"mb-4"},[e("div",{class:"flex items-center justify-between"},[e("h3",{class:"text-base font-medium text-neutral-700 dark:text-neutral-300"},[t.title]),u.extra?.()]),e("div",{class:"mt-2 h-px bg-neutral-200 dark:bg-neutral-700"},null)])}}),he=f({props:{enabled:{type:Boolean,required:!0},size:{type:String,default:"md"}},setup(t){const u={sm:"size-2",md:"size-2.5"};return()=>e("div",{class:"relative flex shrink-0 items-center justify-center"},[t.enabled&&e("span",{class:["absolute inline-flex animate-ping rounded-full bg-green-400 opacity-75",u[t.size]]},null),e("span",{class:["relative inline-flex rounded-full",t.enabled?"bg-green-500":"bg-neutral-400",u[t.size]]},null)])}}),D=f({props:{icon:{type:Object,required:!0},label:{type:String,required:!0},value:{type:[String,Number],required:!0},variant:{type:String,default:"default"}},setup(t){const u={default:"bg-neutral-50 dark:bg-neutral-800/50",success:"bg-green-50 dark:bg-green-950/30",warning:"bg-amber-50 dark:bg-amber-950/30"},l={default:"text-neutral-400",success:"text-green-500",warning:"text-amber-500"};return()=>e("div",{class:["flex items-center gap-4 rounded-lg p-4",u[t.variant]]},[e("div",{class:["shrink-0 text-2xl",l[t.variant]]},[t.icon]),e("div",{class:"min-w-0 flex-1"},[e("div",{class:"text-2xl font-semibold tabular-nums"},[typeof t.value=="number"?Intl.NumberFormat("zh-CN").format(t.value):t.value]),e("div",{class:"text-xs text-neutral-500"},[t.label])])])}}),fe=f({props:{webhook:{type:Object,required:!0},onEdit:{type:Function,required:!0},onDelete:{type:Function,required:!0},onTest:{type:Function,required:!0}},setup(t){const u=F(!1),l=a=>a==="all"?"info":a.includes("create")?"success":a.includes("update")?"warning":a.includes("delete")?"error":"default",p=a=>{const r=[];return(a&b.TO_VISITOR)===b.TO_VISITOR&&r.push("访客"),(a&b.TO_ADMIN)===b.TO_ADMIN&&r.push("管理员"),(a&b.TO_SYSTEM)===b.TO_SYSTEM&&r.push("系统"),r.join(", ")||"未指定"};return()=>e("div",{class:"overflow-hidden rounded-lg border border-neutral-200 bg-white transition-all hover:border-neutral-300 dark:border-neutral-700 dark:bg-neutral-800/50 dark:hover:border-neutral-600"},[e("div",{class:"p-4"},[e("div",{class:"flex items-start gap-4"},[e("div",{class:"relative mt-1 flex shrink-0 items-center justify-center"},[e("div",{class:"flex size-10 items-center justify-center rounded-lg bg-neutral-100 dark:bg-neutral-700"},[e(I,{class:"size-5 text-neutral-500 dark:text-neutral-400"},null)]),e("div",{class:"absolute -bottom-1 -right-1"},[e(he,{enabled:t.webhook.enabled,size:"sm"},null)])]),e("div",{class:"min-w-0 flex-1"},[e("div",{class:"flex items-center gap-2"},[e("span",{class:"truncate font-medium text-neutral-800 dark:text-neutral-200"},[t.webhook.payloadUrl||t.webhook.url]),e("a",{href:t.webhook.payloadUrl||t.webhook.url,target:"_blank",rel:"noopener noreferrer",class:"shrink-0 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300",onClick:a=>a.stopPropagation(),"aria-label":"在新标签页打开"},[e($,{class:"size-4"},null)])]),e("div",{class:"mt-2 flex flex-wrap gap-1.5"},[t.webhook.events.slice(0,5).map(a=>e(q,{key:a,size:"small",type:l(a),round:!0,bordered:!1},W(a)?a:{default:()=>[a]})),t.webhook.events.length>5&&e(q,{size:"small",round:!0,bordered:!1},{default:()=>[i("+"),t.webhook.events.length-5]})]),e("div",{class:"mt-2 flex items-center gap-4 text-xs text-neutral-500"},[e("span",null,[i("Scope: "),p(t.webhook.scope)]),e("span",null,[i("状态:")," ",e("span",{class:t.webhook.enabled?"text-green-600 dark:text-green-400":"text-neutral-500"},[t.webhook.enabled?"启用":"禁用"])])])]),e("div",{class:"flex shrink-0 items-center gap-1"},[e("button",{class:"rounded-lg p-2 text-neutral-400 transition-colors hover:bg-blue-50 hover:text-blue-500 dark:hover:bg-blue-950/50",onClick:t.onEdit,"aria-label":"编辑"},[e(H,{class:"size-4"},null)]),e(X,{positiveText:"取消",negativeText:"删除",onNegativeClick:t.onDelete},{trigger:()=>e("button",{class:"rounded-lg p-2 text-neutral-400 transition-colors hover:bg-red-50 hover:text-red-500 dark:hover:bg-red-950/50","aria-label":"删除"},[e(J,{class:"size-4"},null)]),default:()=>e("span",{class:"max-w-48"},[i("确定要删除此 Webhook 吗？")])})])])]),e("div",{class:"border-t border-neutral-100 bg-neutral-50/50 px-4 py-2 dark:border-neutral-700 dark:bg-neutral-800/30"},[e("div",{class:"flex items-center justify-between"},[e("button",{class:"flex items-center gap-1 text-xs text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300",onClick:()=>u.value=!u.value},[e(be,{class:["size-4 transition-transform",u.value&&"rotate-90"]},null),u.value?"收起详情":"展开详情"]),e(Z,{size:"tiny",placeholder:"选择事件测试",options:t.webhook.events.map(a=>({label:a,value:a})),style:{width:"150px"},onUpdateValue:a=>t.onTest(a)},{action:()=>e("div",{class:"flex items-center gap-1 text-xs text-neutral-500"},[e(ve,{class:"size-3"},null),i("发送测试")])})]),u.value&&e("div",{class:"mt-3 space-y-2 text-xs"},[e("div",{class:"flex gap-2"},[e("span",{class:"shrink-0 text-neutral-500"},[i("全部事件:")]),e("div",{class:"flex flex-wrap gap-1"},[t.webhook.events.map(a=>e("span",{key:a,class:"rounded bg-neutral-100 px-1.5 py-0.5 dark:bg-neutral-700"},[a]))])]),t.webhook.created&&e("div",{class:"text-neutral-500"},[i("创建时间:")," ",new Date(t.webhook.created).toLocaleString("zh-CN")]),t.webhook.updated&&e("div",{class:"text-neutral-500"},[i("更新时间:")," ",new Date(t.webhook.updated).toLocaleString("zh-CN")])])])])}}),me=f({props:{show:{type:Boolean,required:!0},formData:{type:Object},onClose:{type:Function,required:!0},onSubmit:{type:Function,required:!0}},setup(t){const u=w(()=>!!t.formData?.id),l=F({events:[],enabled:!0,scope:b.TO_SYSTEM}),{data:p}=_({queryKey:y.webhooks.events(),queryFn:()=>k.getEvents()}),a=w(()=>p.value??[]);ee(()=>t.formData,v=>{v?l.value=le(v):l.value={events:[],enabled:!0,scope:b.TO_SYSTEM}},{immediate:!0});const r=w(()=>new Set(l.value.events)),C=()=>{t.onSubmit(l.value)};return()=>{let v;return e(te,{show:t.show,onUpdateShow:s=>!s&&t.onClose(),width:500,placement:"right"},{default:()=>[e(ue,{title:u.value?"编辑 Webhook":"创建 Webhook",closable:!0},{default:()=>[e("div",{class:"space-y-6"},[e(se,{labelPlacement:"top"},{default:()=>[e(x,{label:"Payload URL",required:!0},{default:()=>[e(O,{value:l.value.payloadUrl,onUpdateValue:s=>l.value.payloadUrl=s,placeholder:"https://example.com/webhook"},null)]}),e(x,{label:"Secret"},{default:()=>[e(O,{value:l.value.secret,onUpdateValue:s=>l.value.secret=s,type:"password",showPasswordOn:"click",placeholder:u.value?"留空保持不变":"可选的签名密钥"},null)]}),e(x,{label:"触发事件",required:!0},{default:()=>[e(ne,{nativeScrollbar:!1,class:"!h-[300px] rounded-lg border border-neutral-200 !bg-neutral-50 p-3 dark:border-neutral-700 dark:!bg-neutral-800/50"},{default:()=>[e("div",{class:"mb-3 border-b border-neutral-200 pb-3 dark:border-neutral-700"},[e(T,{checked:r.value.has("all"),onUpdateChecked:s=>{s?l.value.events=["all"]:l.value.events=[]}},{default:()=>[e("span",{class:"font-medium"},[i("全部事件")])]})]),e(re,{cols:2,xGap:12,yGap:8},W(v=a.value.map(s=>e(oe,{key:s},{default:()=>[e(T,{checked:r.value.has(s)||r.value.has("all"),disabled:r.value.has("all"),onUpdateChecked:h=>{const d=l.value.events||[];h?l.value.events=[...d,s]:l.value.events=d.filter(c=>c!==s)}},{default:()=>[e("span",{class:"text-sm"},[s])]})]})))?v:{default:()=>[v]})]})]}),e(x,{label:"触发范围"},{default:()=>[e("div",{class:"flex flex-wrap gap-3"},[Object.keys(b).map(s=>{const h=b[s],d=l.value.scope??0,c={TO_VISITOR:"访客操作",TO_ADMIN:"管理员操作",TO_SYSTEM:"系统事件",ALL:"全部"};return e(T,{key:s,checked:(d&h)===h||d===b.ALL,onUpdateChecked:S=>{S?l.value.scope=(l.value.scope??0)|h:l.value.scope=(l.value.scope??0)&~h}},{default:()=>[c[s]||s]})})])]}),e(x,{label:"启用状态"},{default:()=>[e("div",{class:"flex items-center gap-3"},[e(ie,{value:l.value.enabled,onUpdateValue:s=>l.value.enabled=s},null),e("span",{class:"text-sm text-neutral-600 dark:text-neutral-400"},[l.value.enabled?"已启用，将接收事件推送":"已禁用，暂停接收事件"])])]})]}),e("div",{class:"flex justify-end gap-3"},[e(N,{onClick:t.onClose},{default:()=>[i("取消")]}),e(N,{type:"primary",onClick:C},{default:()=>[u.value?"保存":"创建"]})])])]})]})}}}),ge=f({setup(){return()=>e("div",{class:"rounded-lg border border-neutral-200 bg-white p-4 dark:border-neutral-700 dark:bg-neutral-800/50"},[e("div",{class:"flex items-start gap-4"},[e(g,{width:40,height:40},null),e("div",{class:"flex-1 space-y-3"},[e(g,{text:!0,width:"70%"},null),e("div",{class:"flex gap-2"},[e(g,{text:!0,width:60},null),e(g,{text:!0,width:60},null),e(g,{text:!0,width:60},null)]),e(g,{text:!0,width:"40%"},null)])])])}}),ye=f({setup(){const t=P(),{data:u,isLoading:l,refetch:p}=_({queryKey:y.webhooks.list(),queryFn:()=>k.getList()}),a=w(()=>u.value??[]),r=w(()=>a.value.filter(n=>n.enabled).length),C=E({mutationFn:k.create,onSuccess:()=>{message.success("Webhook 创建成功"),t.invalidateQueries({queryKey:y.webhooks.all}),d.value=!1,c.value=void 0}}),v=E({mutationFn:({id:n,data:o})=>k.update(n,o),onSuccess:()=>{message.success("Webhook 更新成功"),t.invalidateQueries({queryKey:y.webhooks.all}),d.value=!1,c.value=void 0}}),s=E({mutationFn:k.delete,onSuccess:()=>{message.success("Webhook 已删除"),t.invalidateQueries({queryKey:y.webhooks.all})}}),h=E({mutationFn:({id:n,event:o})=>k.test(n,o),onSuccess:()=>{message.success("测试请求已发送")},onError:()=>{message.error("测试请求发送失败")}}),d=F(!1),c=F(),S=()=>{c.value=void 0,d.value=!0},L=n=>{c.value=n,d.value=!0},M=n=>{if(c.value?.id){const o={...n};o.secret||delete o.secret,v.mutate({id:c.value.id,data:o})}else C.mutate(n)},j=n=>{s.mutate(n)},U=(n,o)=>{h.mutate({id:n,event:o})},{setActions:V}=R();return Y(()=>{V(e(ce,null,[e(z,{icon:e(de,null,null),onClick:()=>p(),name:"刷新"},null),e(z,{icon:e(B,null,null),onClick:S,name:"添加 Webhook",variant:"primary"},null)]))}),()=>e("div",{class:"space-y-8"},[e("section",null,[e(A,{title:"概览"},null),e("div",{class:"grid grid-cols-1 gap-4 sm:grid-cols-3"},[e(D,{icon:e(I,null,null),label:"总 Webhook 数",value:a.value.length,variant:"default"},null),e(D,{icon:e(K,null,null),label:"已启用",value:r.value,variant:"success"},null),e(D,{icon:e(Q,null,null),label:"已禁用",value:a.value.length-r.value,variant:a.value.length-r.value>0?"warning":"default"},null)])]),e("section",null,[e(A,{title:"Webhook 列表"},{extra:()=>e("span",{class:"text-sm text-neutral-500"},[i("共 "),a.value.length,i(" 个 Webhook")])}),l.value?e("div",{class:"space-y-3"},[Array.from({length:3}).map((n,o)=>e(ge,{key:o},null))]):a.value.length===0?e("div",{class:"rounded-lg border border-dashed border-neutral-200 py-16 dark:border-neutral-700"},[e(G,{description:"暂无 Webhook"},{extra:()=>e("div",{class:"mt-4"},[e(N,{type:"primary",onClick:S},{default:()=>[e(B,{class:"mr-2 size-4"},null),i("创建第一个 Webhook")]})])})]):e("div",{class:"space-y-3"},[a.value.map(n=>e(fe,{key:n.id,webhook:n,onEdit:()=>L(n),onDelete:()=>j(n.id),onTest:o=>U(n.id,o)},null))])]),e(me,{show:d.value,formData:c.value,onClose:()=>{d.value=!1,c.value=void 0},onSubmit:M},null)])}});export{ye as default};
