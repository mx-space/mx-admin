import{d as E,h as k,o as R,a as p,ab as N,a2 as m,r as S,O as H,ac as M,G as $,f as q,w as L,i as a,ad as V,ae as U,H as h,af as W,ag as j,Y as x,ah as z,ai as Y,aj as G,ak as O,al as _,j as J,am as K,an as Q,ao as X,a3 as Z,a0 as ee,ap as te,aq as ae}from"./index-R5yA_R4y.js";import{p as v}from"./pages-BGffIDtr.js";import{F as le}from"./file-text-Cg4mMqcI.js";const re=E(()=>{const y=ee(),{setTitle:b,setHeaderClass:D,setActions:I,setContentPadding:F,setHeaderSubtitle:C}=k();F(!1);const P=()=>({text:"",title:"",order:0,slug:"",subtitle:"",allowComment:!0,id:void 0,images:[],meta:void 0}),A=t=>M(e)(t),e=R(P()),r=p(()=>y.query.id),w=p(()=>y.query.draftId),B=p(()=>!!(r.value&&typeof e.id>"u")),n=$(),l=N(m.Page,{refId:r.value,draftId:w.value,interval:1e4,getData:()=>({title:e.title,text:e.text,images:e.images,meta:e.meta,typeSpecificData:{slug:e.slug,subtitle:e.subtitle,order:e.order}}),onDraftCreated:t=>{n.replace({query:{draftId:t}})},onTitleFallback:t=>{e.title=t}}),d=S(!1);H(async()=>{const t=r.value,o=w.value;if(o){const u=await l.loadDraftById(o);if(u){if(e.title=u.title,e.text=u.text,e.images=u.images||[],e.meta=u.meta,u.typeSpecificData){const s=u.typeSpecificData;e.slug=s.slug||"",e.subtitle=s.subtitle||"",e.order=s.order??0}l.syncMemory(),l.startAutoSave(),d.value=!0;return}}if(t&&typeof t=="string"){const u=await v.getById(t);A(u);const s=await l.loadDraftByRef(m.Page,t);s?window.dialog.info({title:"检测到未保存的草稿",content:`上次保存时间: ${new Date(s.updated).toLocaleString()}`,negativeText:"使用已发布版本",positiveText:"恢复草稿",onNegativeClick(){l.syncMemory(),l.startAutoSave()},onPositiveClick(){if(e.title=s.title,e.text=s.text,e.images=s.images||[],e.meta=s.meta,s.typeSpecificData){const g=s.typeSpecificData;e.slug=g.slug||e.slug,e.subtitle=g.subtitle||e.subtitle,e.order=g.order??e.order}l.syncMemory(),l.startAutoSave()}}):(l.syncMemory(),l.startAutoSave()),d.value=!0;return}const i=await l.getNewDrafts(m.Page);i.length>0?window.dialog.info({title:"发现未完成的草稿",content:`你有 ${i.length} 个未完成的页面草稿，是否继续编辑？`,negativeText:"创建新草稿",positiveText:"继续编辑",onNegativeClick(){l.startAutoSave()},onPositiveClick(){const u=i[0];n.replace({query:{draftId:u.id}})}}):l.startAutoSave(),d.value=!0});const c=S(!1),f=q(),T=async()=>{const t=()=>{try{if(!e.title||e.title.trim().length==0)throw"标题为空";if(!e.slug)throw"路径为空";return{...te(e),title:e.title.trim(),slug:e.slug.trim()}}catch(i){throw f.error(i),i}},o=l.draftId.value;if(r.value){if(!X(r.value))return;const i=r.value;await v.update(i,{...t(),draftId:o}),f.success("修改成功")}else await v.create({...t(),draftId:o}),f.success("发布成功");n.push({name:Z.ListPage,hash:"|publish"})};return D("pt-1"),b(r.value?"修改页面":"新建页面"),L(()=>{C(a(ae,{isSaving:l.isSaving,lastSavedTime:l.lastSavedTime},null))}),I(a(x,null,[a(V,{data:e,onHandleYamlParsedMeta:t=>{const{title:o,slug:i,subtitle:u,...s}=t;e.title=o??e.title,e.slug=i??e.slug,e.subtitle=u??e.subtitle,e.meta={...s}}},null),a(U,{iframe:!0,data:e},null),a(h,{icon:a(W,null,null),name:"页面设置",onClick:()=>{c.value=!0}},null),a(h,{icon:a(j,null,null),name:"发布",variant:"primary",onClick:T},null)])),()=>a(x,null,[a(z,{key:e.id,loading:B.value,autoFocus:r.value?"content":"title",title:e.title,onTitleChange:t=>{e.title=t},titlePlaceholder:"输入标题...",text:e.text,onChange:t=>{e.text=t},subtitleSlot:()=>a("div",{class:"space-y-2"},[a(Y,{prefix:`${G}/`,value:e.slug,onChange:t=>{e.slug=t},placeholder:"slug"},null),a("input",{class:["w-full bg-transparent outline-none","text-sm text-neutral-600 dark:text-neutral-400","border-none px-1 py-0.5","placeholder:text-neutral-400 dark:placeholder:text-neutral-500"],placeholder:"输入副标题...",value:e.subtitle,onInput:t=>{e.subtitle=t.target.value}},null)])},null),a(O,{title:"页面设定",disabledItem:["date-picker"],onUpdateShow:t=>{c.value=t},data:e,show:c.value},{default:()=>[a(_,{icon:le},{default:()=>[J("页面选项")]}),a(K,{label:"页面顺序",description:"用于控制页面在导航中的显示顺序"},{default:()=>[a(Q,{class:"w-full",placeholder:"输入排序数字",value:e.order,onUpdateValue:t=>void(e.order=t??0),min:0},null)]})]})])});export{re as default};
