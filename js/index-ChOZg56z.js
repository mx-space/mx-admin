import{ar as d,d as w,r as y,b4 as Z,h as e,ax as E,aw as ee,b5 as v,x as $,b2 as f,V as M,z as A,B as h,i,aC as te,A as ae,a0 as ue,_ as le,b6 as D,u as ne,a as se,f as N,b0 as re,g as ie,w as oe,az as de,G as ce,a3 as ve,aA as B,aB as pe,K as me,b7 as V,Y as P,m as fe,p as ye,v as ge,q as k,s as c,H as j,P as ke,b8 as he,b9 as be}from"./index-DoEgFLcO.js";import{o as xe}from"./omit-DkrjnpVZ.js";const m={getList:a=>d.get("/links",{params:a}),getStateCount:()=>d.get("/links/state"),getById:a=>d.get(`/links/${a}`),create:a=>d.post("/links",{data:a}),update:(a,n)=>d.put(`/links/${a}`,{data:n}),delete:a=>d.delete(`/links/${a}`),updateState:(a,n)=>d.patch(`/links/${a}`,{data:{state:n}}),checkHealth:a=>d.get("/links/health",{timeout:a?.timeout}),auditPass:a=>d.patch(`/links/audit/${a}`),auditWithReason:(a,n,s)=>d.post(`/links/audit/reason/${a}`,{data:{state:n,reason:s}}),migrateAvatars:a=>d.post("/links/avatar/migrate",{timeout:a?.timeout})},T={Audit:"待审核",Pass:"通过",Outdate:"过时",Banned:"屏蔽",Reject:"拒绝"},Ce="https://fastly.jsdelivr.net/gh/mx-space/mx-admin@gh-pages/assets/fallback-BjFffESB.jpg";function O(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!ee(a)}const I=w(a=>{const n=y(),s=y(!1),g=Z(n,o=>{o[0].isIntersecting&&(s.value=!0,g.stop())});return()=>{let o,r;return e("div",{ref:n},[a.avatar?s.value?e(E,{src:a.avatar,round:!0,onError:x=>{x.target.src=Ce}},null):e(E,{round:!0},O(o=a.name.charAt(0))?o:{default:()=>[o]}):e(E,{round:!0},O(r=a.name.charAt(0))?r:{default:()=>[r]})])}});I.props=["avatar","name"];const Fe=w({props:{onCallback:{type:Function,required:!0}},setup(a){const n=y(""),s=y(v.Pass),g=Object.entries(T).filter(([r])=>r!=="Audit").map(([r,x])=>({value:v[r],key:r,label:x})),o=()=>{a.onCallback(s.value,n.value)};return()=>e($,{class:"mt-6"},{default:()=>[e(f,{label:"状态"},{default:()=>[e(M,{value:s.value,onUpdateValue:r=>s.value=r,options:g},null)]}),e(f,{label:"原因"},{default:()=>[e(A,{type:"textarea",value:n.value,onUpdateValue:r=>n.value=r,placeholder:"请输入原因",maxlength:200,autosize:{maxRows:4,minRows:2}},null)]}),e("div",{class:"flex justify-end"},[e(h,{round:!0,type:"primary",onClick:o},{default:()=>[i("发送")]})])]})}}),Be=w({props:{url:String,errorMessage:String,status:[String,Number]},setup(a){return()=>e("div",{class:"flex items-center space-x-2"},[e("a",{target:"_blank",href:a.url,rel:"noreferrer"},[a.url]),typeof a.status<"u"&&(a.errorMessage?e(te,null,{trigger(){return e("div",{class:"h-2 w-2 rounded-full bg-red-400"},null)},default(){return a.errorMessage}}):e("div",{class:"h-2 w-2 rounded-full bg-green-300"},null))])}}),qe=w({setup(){const a=ue(),n=ce(),s=ae(),g=y(a.query.state??v.Pass),{data:o,pager:r,isLoading:x,refresh:K}=le({queryKey:t=>k.links.list({...t,state:t.filters?.state}),queryFn:t=>m.getList({page:t.page,size:t.size,state:t.filters?.state}),pageSize:50,filters:()=>({state:g.value})}),S=()=>({avatar:"",name:"",type:D.Friend,url:"",id:null,description:"",state:v.Pass}),b=y(!1),l=y(S()),{data:L,refetch:q}=ne({queryKey:k.links.stateCount(),queryFn:m.getStateCount}),C=se(()=>L.value||{}),_=N({mutationFn:async t=>{const u=t.id;return u?await m.update(u,xe(t,["id","created","hide"])):await m.create(t)},onSuccess:()=>{c.success("操作成功"),s.invalidateQueries({queryKey:k.links.all}),q(),b.value=!1,l.value=S()}}),Q=N({mutationFn:m.delete,onSuccess:()=>{c.success("删除成功"),s.invalidateQueries({queryKey:k.links.all}),q()}}),U=N({mutationFn:m.auditPass,onSuccess:(t,u)=>{const p=o.value.find(F=>F.id===u);c.success(`通过了来自${p?.name||""}的友链邀请`),s.invalidateQueries({queryKey:k.links.all}),q()}}),H=N({mutationFn:({id:t,state:u,reason:p})=>m.auditWithReason(t,u,p),onSuccess:(t,{id:u})=>{const p=o.value.find(F=>F.id===u);c.success(`已发送友链结果给「${p?.name||""}」`),s.invalidateQueries({queryKey:k.links.all}),q()}}),W=()=>{_.mutate(l.value)},z=y(),G=async()=>{const t=c.loading("检查中",{duration:2e5});try{const u=await m.checkHealth({timeout:2e5});z.value=Object.entries(u).reduce((p,[F,X])=>({...p,[F.toLowerCase()]:X}),{}),c.success("检查完成")}catch(u){console.error(u)}finally{requestAnimationFrame(()=>{c.dismiss(t)})}},Y=async()=>{const t=c.loading("迁移中",{duration:2e5});try{await m.migrateAvatars({timeout:2e5}),c.success("迁移完成"),s.invalidateQueries({queryKey:k.links.all})}catch(u){console.error(u),c.error("迁移失败")}finally{requestAnimationFrame(()=>{c.dismiss(t)})}},R=re(),{setActions:J}=ie();return oe(()=>{J(e(P,null,[e(j,{icon:e(ke,null,null),variant:"primary",onClick:()=>{l.value=S(),b.value=!0}},null),e(j,{icon:e(he,null,null),variant:"info",onClick:G,name:"检查友链可用性"},null),e(j,{icon:e(be,null,null),variant:"info",onClick:Y,name:"迁移头像"},null)]))}),()=>e(P,null,[e("section",{class:"mb-4"},[e(de,{class:"min-h-[30px]",size:"medium",value:g.value,onUpdateValue:t=>{g.value=t,n.replace({name:ve.Friend,query:{state:t}})}},{default:()=>[e(B,{name:v.Pass,tab:()=>e("div",{class:"flex items-center gap-2"},[e("span",null,[i("朋友们")]),e("span",{class:"rounded-full bg-neutral-100 px-2 py-0.5 text-xs text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400"},[C.value.friends||0])])},null),e(B,{name:v.Audit,tab:()=>e("div",{class:"flex items-center gap-2"},[e("span",null,[i("待审核")]),e("span",{class:"rounded-full bg-red-100 px-2 py-0.5 text-xs text-red-600 dark:bg-red-900/30 dark:text-red-400"},[C.value.audit||0])])},null),e(B,{name:v.Outdate,tab:()=>e("div",{class:"flex items-center gap-2"},[e("span",null,[i("过时的")]),e("span",{class:"rounded-full bg-neutral-100 px-2 py-0.5 text-xs text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400"},[C.value.outdate||0])])},null),e(B,{name:v.Reject,tab:()=>e("div",{class:"flex items-center gap-2"},[e("span",null,[i("已拒绝")]),e("span",{class:"rounded-full bg-neutral-100 px-2 py-0.5 text-xs text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400"},[C.value.reject||0])])},null),e(B,{name:v.Banned,tab:()=>e("div",{class:"flex items-center gap-2"},[e("span",null,[i("封禁的")]),e("span",{class:"rounded-full bg-neutral-100 px-2 py-0.5 text-xs text-neutral-600 dark:bg-neutral-800 dark:text-neutral-400"},[C.value.banned||0])])},null)]})]),e("section",null,[e(pe,{loading:x.value,data:o,nTableProps:{maxHeight:"calc(100vh - 12rem)"},columns:[{title:"头像",key:"avatar",width:80,render(t){return e(I,{name:t.name,avatar:t.avatar},null)}},{title:"名称",key:"name",render(t){return e("a",{target:"_blank",href:t.url,rel:"noreferrer",class:"hover:text-primary-600 dark:hover:text-primary-400 text-neutral-700 dark:text-neutral-300"},[t.name])}},{title:"描述",key:"description",width:250,ellipsis:{lineClamp:2,tooltip:!0}},{title:"网址",key:"url",render(t){const u=z.value?.[t.id];return e(Be,{url:t.url,errorMessage:u?.message,status:u?.status},null)}},{title:"类型",key:"type",width:80,render(t){return["朋友","收藏"][t.type|0]}},{title:"对方邮箱",key:"email",render(t){return e("a",{href:`mailto:${t.email}`,class:"hover:text-primary-600 dark:hover:text-primary-400 text-neutral-600 dark:text-neutral-400"},[t.email])}},{title:"结识时间",key:"created",width:80,render(t){return e(me,{time:t.created},null)}},{width:150,title:"操作",fixed:"right",key:"action",render(t){return e(V,{wrap:!1},{default:()=>[t.state==v.Audit&&e(P,null,[e(h,{quaternary:!0,size:"tiny",type:"primary",onClick:()=>U.mutate(t.id)},{default:()=>[i("通过")]}),e(h,{quaternary:!0,size:"tiny",type:"info",onClick:()=>{R.create({title:"发送友链结果",closeOnEsc:!0,closable:!0,content:()=>e(Fe,{onCallback:(u,p)=>{H.mutate({id:t.id,state:u,reason:p},{onSuccess:()=>{R.destroyAll()}})}},null)})}},{default:()=>[i("理由")]})]),e(h,{quaternary:!0,size:"tiny",type:"info",onClick:()=>{b.value=!0,l.value={...t}}},{default:()=>[i("编辑")]}),e(fe,{positiveText:"取消",negativeText:"删除",onNegativeClick:()=>Q.mutate(t.id)},{trigger:()=>e(h,{quaternary:!0,type:"error",size:"tiny"},{default:()=>[i("移除")]}),default:()=>e("span",{class:"max-w-48"},[i("确定要删除友链 "),t.name,i(" ?")])})]})}}],onFetchData:K,pager:r},null)]),e(ye,{transformOrigin:"center",show:b.value,onUpdateShow:t=>void(b.value=t)},{default:()=>[e(ge,{style:"width: 500px;max-width: 90vw",headerStyle:{textAlign:"center"},title:l.value.id?`编辑: ${l.value.name}`:"新增"},{default:()=>[e($,null,{default:()=>[e(f,{label:"名字",required:!0},{default:()=>[e(A,{autofocus:!0,value:l.value.name,onInput:t=>void(l.value.name=t)},null)]}),e(f,{label:"头像"},{default:()=>[e(A,{autofocus:!0,value:l.value.avatar,onInput:t=>void(l.value.avatar=t)},null)]}),e(f,{label:"网址",required:!0},{default:()=>[e(A,{autofocus:!0,value:l.value.url,onInput:t=>void(l.value.url=t)},null)]}),e(f,{label:"描述"},{default:()=>[e(A,{autofocus:!0,value:l.value.description,onInput:t=>void(l.value.description=t)},null)]}),e(f,{label:"类型"},{default:()=>[e(M,{placeholder:"选择类型",options:[{label:"朋友",value:D.Friend},{label:"收藏",value:D.Collection}],value:l.value.type,onUpdateValue:t=>void(l.value.type=t|0)},null)]}),l.value.id&&e(f,{label:"状态"},{default:()=>[e(M,{placeholder:"选择状态",options:Object.entries(T).map(([t,u])=>({label:u,value:v[t]})),value:l.value.state,onUpdateValue:t=>void(l.value.state=t|0)},null)]})]}),e("div",{class:"text-right"},[e(V,{size:12,align:"center",inline:!0},{default:()=>[e(h,{type:"primary",onClick:W,round:!0},{default:()=>[i("确定")]}),e(h,{onClick:()=>{b.value=!1,l.value=S()},round:!0},{default:()=>[i("取消")]})]})])]})]})])}});export{qe as default};
