import{d as y,aT as A,r as b,g as x,aU as N,h as t,aV as k,aW as G,aX as q,aY as z,aZ as T,a_ as H,a$ as O,v as _,x as C,p as L,b0 as W,H as j,O as M,z as f,B as X,i as Y,Y as P,n as K,a as Z,ac as J,f as B,ag as Q,ao as ee,a0 as te,b1 as ae,ap as le,s as F,G as ne,a3 as U,b2 as p,b3 as oe}from"./index-DoEgFLcO.js";import{p as w}from"./projects-CLT17GpZ.js";const ue=y({name:"EditorX",props:{...A,loading:{type:Boolean,required:!0}},expose:["setValue"],setup(r,{expose:s}){const l=b(!1),d=x();N(()=>{const n=d.addFloatButton(t(G,{icon:t(k,null,null),label:"编辑器设置",onClick:()=>{l.value=!0}},null));return()=>{d.removeFloatButton(n)}});const{general:a,destory:o}=q();z(()=>{o()});const i=y({setup(){const n=()=>{l.value=!1},{Panel:c}=a,v=h=>void(l.value=h);return()=>t(L,{transformOrigin:"center",show:l.value,onUpdateShow:v},{default:()=>[t(_,{closable:!0,onClose:n,title:"编辑器设定",style:"max-width: 90vw;width: 500px; max-height: 65vh; overflow: auto",bordered:!1},{default:()=>[t(C,{labelPlacement:"left",labelWidth:"8rem",labelAlign:"right"},{default:()=>[t(c,null,null)]})]})]})}}),m=b();return s({setValue:n=>{m.value?.setValue(n)}}),()=>{const{setting:n}=a,c=r.renderMode??n.renderMode??"plain";return t(O,{tag:"div",style:{"--editor-font-size":n.fontSize?`${n.fontSize/14}rem`:"","--editor-font-family":n.fontFamily},class:"editor-wrapper"},{default:()=>[t(T,H({ref:m},r,{renderMode:c}),null),t(i,null,null)]})}}}),I="https://api.github.com/",re=(r,s)=>fetch(`${I}repos/${r}/${s}`).then(l=>l.json()),se=(r,s)=>fetch(`${I}repos/${r}/${s}/readme`).then(l=>l.json()).catch(l=>null).then(l=>{if(l){const d=(()=>{const a=l.download_url.split("/"),o=a.pop(),i=a.pop();return`https://fastly.jsdelivr.net/gh/${r}/${s}@${i}/${o}`})();return fetch(d).then(a=>a.text())}return null}),ce=()=>t("svg",{width:"1em",height:"1em",viewBox:"0 0 24 24"},[t("path",{d:"M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33c.85 0 1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z",fill:"#fff"},null)]),ie=y({props:{onData:{type:Function,required:!0},defaultValue:{type:String}},setup(r){const s=W(),l=()=>{const d=s.create({title:"从 GitHub 解析",content:()=>t(y({setup(){const o=b(r.defaultValue??""),i=b(!1),m=async()=>{i.value=!0;const v=o.value.replace(/\.git$/,"").replace(/^https?:\/\/github.com\//,""),[h,e]=v.split("/"),[u,g]=await Promise.all([re(h,e),se(h,e)]);r.onData(u,g),i.value=!1,requestAnimationFrame(()=>{d.destroy()})},n=b();return M(()=>{setTimeout(()=>{n.value.focus()},10)}),()=>t(P,null,[t(f,{ref:n,onKeydown:c=>{c.code==="Enter"&&m()},class:"my-4",value:o.value,placeholder:"在此输入项目地址",onUpdateValue:c=>void(o.value=c)},null),t("div",{class:"flex justify-end space-x-4"},[t(X,{type:"primary",round:!0,onClick:m,loading:i.value},{default:()=>[Y("获取")]})])])}}),null,null)})};return()=>t(j,{icon:t(ce,null,null),name:"从 GitHub 获取",onClick:l},null)}}),fe=y({setup(){const r=te(),s=ne(),l=()=>({name:"",previewUrl:"",docUrl:"",projectUrl:"",images:[],description:"",avatar:"",text:"",id:void 0}),d=e=>J(a)(e),a=K(l()),o=Z(()=>r.query.id);M(async()=>{const e=o.value;if(e&&typeof e=="string"){const u=await w.getById(e);d(u)}});const i=()=>{try{if(!a.text||a.text.trim().length==0)throw"内容为空";return{...ae(le(a),(e,u,g)=>(e[g]=typeof u>"u"?null:typeof u=="string"&&u.length==0?"":u,e)),text:a.text.trim()}}catch(e){throw F.error(e),e}},m=B({mutationFn:e=>w.create(e),onSuccess:()=>{F.success("发布成功"),s.push({name:U.ListProject})}}),n=B({mutationFn:({id:e,data:u})=>w.update(e,u),onSuccess:()=>{F.success("修改成功"),s.push({name:U.ListProject})}}),c=()=>{const e=i();if(o.value){if(!ee(o.value))return;n.mutate({id:o.value,data:e})}else m.mutate(e)},v=(e,u)=>{const{html_url:g,homepage:S,description:$}=e;Object.assign(a,{description:$,projectUrl:g,previewUrl:S,images:(R=>{const V=/(?<=!\[.*]\()(.+)(?=\))/g,E=[];for(const D of R.matchAll(V))E.push(D[0]);return E})(u||""),name:e.name,text:u||""})},{setActions:h}=x();return h(t(P,null,[t(ie,{onData:v,defaultValue:a.projectUrl},null),t(j,{variant:"primary",onClick:c,icon:t(Q,null,null)},null)])),()=>t(C,{labelWidth:"7rem",labelPlacement:"left",labelAlign:"left"},{default:()=>[t(p,{label:"项目名称",required:!0},{default:()=>[t(f,{autofocus:!0,placeholder:"",value:a.name,onInput:e=>void(a.name=e)},null)]}),t(p,{label:"文档地址"},{default:()=>[t(f,{placeholder:"",value:a.docUrl,onInput:e=>void(a.docUrl=e)},null)]}),t(p,{label:"预览地址"},{default:()=>[t(f,{placeholder:"",value:a.previewUrl,onInput:e=>void(a.previewUrl=e)},null)]}),t(p,{label:"项目地址"},{default:()=>[t(f,{placeholder:"",value:a.projectUrl,onInput:e=>void(a.projectUrl=e)},null)]}),t(p,{label:"项目描述",required:!0},{default:()=>[t(f,{placeholder:"",value:a.description,onInput:e=>void(a.description=e)},null)]}),t(p,{label:"项目图标"},{default:()=>[t(f,{placeholder:"",value:a.avatar,onInput:e=>void(a.avatar=e)},null)]}),t(p,{label:"预览图片"},{default:()=>[t(oe,{round:!0,value:a.images,onUpdateValue:e=>void(a.images=e)},null)]}),t(p,{label:"正文",required:!0},{default:()=>[t("div",{class:"w-full"},[t(ue,{unSaveConfirm:!1,class:"h-[calc(100vh-40rem)] min-h-80 w-full",loading:!!(o.value&&!a.id),onChange:e=>{a.text=e},text:a.text},null)])]})]})}});export{fe as default};
