import{d as y,aT as D,r as b,h as U,aU as A,i as t,aV as N,aW as k,aX as G,aY as q,aZ as z,a_ as T,a$ as H,v as O,x,s as _,b0 as L,H as C,O as j,z as f,B as W,j as X,Y as M,o as Y,a as K,ac as Z,g as E,ag as J,ao as Q,a0 as ee,b1 as te,ap as ae,G as le,a3 as B,b2 as p,b3 as ne}from"./index-qXdkAhVq.js";import{p as F}from"./projects-DympUeSk.js";const oe=y({name:"EditorX",props:{...D,loading:{type:Boolean,required:!0}},expose:["setValue"],setup(r,{expose:s}){const l=b(!1),d=U();A(()=>{const n=d.addFloatButton(t(k,{icon:t(N,null,null),label:"编辑器设置",onClick:()=>{l.value=!0}},null));return()=>{d.removeFloatButton(n)}});const{general:a,destory:o}=G();q(()=>{o()});const i=y({setup(){const n=()=>{l.value=!1},{Panel:c}=a,v=h=>void(l.value=h);return()=>t(_,{transformOrigin:"center",show:l.value,onUpdateShow:v},{default:()=>[t(O,{closable:!0,onClose:n,title:"编辑器设定",style:"max-width: 90vw;width: 500px; max-height: 65vh; overflow: auto",bordered:!1},{default:()=>[t(x,{labelPlacement:"left",labelWidth:"8rem",labelAlign:"right"},{default:()=>[t(c,null,null)]})]})]})}}),m=b();return s({setValue:n=>{m.value?.setValue(n)}}),()=>{const{setting:n}=a,c=r.renderMode??n.renderMode??"plain";return t(H,{tag:"div",style:{"--editor-font-size":n.fontSize?`${n.fontSize/14}rem`:"","--editor-font-family":n.fontFamily},class:"editor-wrapper"},{default:()=>[t(z,T({ref:m},r,{renderMode:c}),null),t(i,null,null)]})}}}),P="https://api.github.com/",ue=(r,s)=>fetch(`${P}repos/${r}/${s}`).then(l=>l.json()),re=(r,s)=>fetch(`${P}repos/${r}/${s}/readme`).then(l=>l.json()).catch(l=>null).then(l=>{if(l){const d=(()=>{const a=l.download_url.split("/"),o=a.pop(),i=a.pop();return`https://fastly.jsdelivr.net/gh/${r}/${s}@${i}/${o}`})();return fetch(d).then(a=>a.text())}return null}),se=()=>t("svg",{width:"1em",height:"1em",viewBox:"0 0 24 24"},[t("path",{d:"M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33c.85 0 1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z",fill:"#fff"},null)]),ce=y({props:{onData:{type:Function,required:!0},defaultValue:{type:String}},setup(r){const s=L(),l=()=>{const d=s.create({title:"从 GitHub 解析",content:()=>t(y({setup(){const o=b(r.defaultValue??""),i=b(!1),m=async()=>{i.value=!0;const v=o.value.replace(/\.git$/,"").replace(/^https?:\/\/github.com\//,""),[h,e]=v.split("/"),[u,g]=await Promise.all([ue(h,e),re(h,e)]);r.onData(u,g),i.value=!1,requestAnimationFrame(()=>{d.destroy()})},n=b();return j(()=>{setTimeout(()=>{n.value.focus()},10)}),()=>t(M,null,[t(f,{ref:n,onKeydown:c=>{c.code==="Enter"&&m()},class:"my-4",value:o.value,placeholder:"在此输入项目地址",onUpdateValue:c=>void(o.value=c)},null),t("div",{class:"flex justify-end space-x-4"},[t(W,{type:"primary",round:!0,onClick:m,loading:i.value},{default:()=>[X("获取")]})])])}}),null,null)})};return()=>t(C,{icon:t(se,null,null),name:"从 GitHub 获取",onClick:l},null)}}),me=y({setup(){const r=ee(),s=le(),l=()=>({name:"",previewUrl:"",docUrl:"",projectUrl:"",images:[],description:"",avatar:"",text:"",id:void 0}),d=e=>Z(a)(e),a=Y(l()),o=K(()=>r.query.id);j(async()=>{const e=o.value;if(e&&typeof e=="string"){const u=await F.getById(e);d(u)}});const i=()=>{try{if(!a.text||a.text.trim().length==0)throw"内容为空";return{...te(ae(a),(e,u,g)=>(e[g]=typeof u>"u"?null:typeof u=="string"&&u.length==0?"":u,e)),text:a.text.trim()}}catch(e){throw message.error(e),e}},m=E({mutationFn:e=>F.create(e),onSuccess:()=>{message.success("发布成功"),s.push({name:B.ListProject})}}),n=E({mutationFn:({id:e,data:u})=>F.update(e,u),onSuccess:()=>{message.success("修改成功"),s.push({name:B.ListProject})}}),c=()=>{const e=i();if(o.value){if(!Q(o.value))return;n.mutate({id:o.value,data:e})}else m.mutate(e)},v=(e,u)=>{const{html_url:g,homepage:I,description:S}=e;Object.assign(a,{description:S,projectUrl:g,previewUrl:I,images:($=>{const R=/(?<=!\[.*]\()(.+)(?=\))/g,w=[];for(const V of $.matchAll(R))w.push(V[0]);return w})(u||""),name:e.name,text:u||""})},{setActions:h}=U();return h(t(M,null,[t(ce,{onData:v,defaultValue:a.projectUrl},null),t(C,{variant:"primary",onClick:c,icon:t(J,null,null)},null)])),()=>t(x,{labelWidth:"7rem",labelPlacement:"left",labelAlign:"left"},{default:()=>[t(p,{label:"项目名称",required:!0},{default:()=>[t(f,{autofocus:!0,placeholder:"",value:a.name,onInput:e=>void(a.name=e)},null)]}),t(p,{label:"文档地址"},{default:()=>[t(f,{placeholder:"",value:a.docUrl,onInput:e=>void(a.docUrl=e)},null)]}),t(p,{label:"预览地址"},{default:()=>[t(f,{placeholder:"",value:a.previewUrl,onInput:e=>void(a.previewUrl=e)},null)]}),t(p,{label:"项目地址"},{default:()=>[t(f,{placeholder:"",value:a.projectUrl,onInput:e=>void(a.projectUrl=e)},null)]}),t(p,{label:"项目描述",required:!0},{default:()=>[t(f,{placeholder:"",value:a.description,onInput:e=>void(a.description=e)},null)]}),t(p,{label:"项目图标"},{default:()=>[t(f,{placeholder:"",value:a.avatar,onInput:e=>void(a.avatar=e)},null)]}),t(p,{label:"预览图片"},{default:()=>[t(ne,{round:!0,value:a.images,onUpdateValue:e=>void(a.images=e)},null)]}),t(p,{label:"正文",required:!0},{default:()=>[t("div",{class:"w-full"},[t(oe,{unSaveConfirm:!1,class:"h-[calc(100vh-40rem)] min-h-80 w-full",loading:!!(o.value&&!a.id),onChange:e=>{a.text=e},text:a.text},null)])]})]})}});export{me as default};
