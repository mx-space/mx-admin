import{d as k,h as R,o as N,a as m,ab as H,a2 as v,r as h,O as M,ac as $,G as q,f as L,w as V,i as a,ad as U,ae as W,H as x,af as j,ag as z,Y as D,ah as Y,ai as G,aj as O,ak as _,al as J,j as K,am as Q,an as X,ao as Z,a3 as ee,a0 as te,ap as ae,aq as le}from"./index-qXdkAhVq.js";import{p as y}from"./pages-By6mJMZX.js";import{F as se}from"./file-text-_GuHUxW8.js";const oe=k(()=>{const w=te(),{setTitle:b,setHeaderClass:I,setActions:F,setContentPadding:C,setHeaderSubtitle:P}=R();C(!1);const A=()=>({text:"",title:"",order:0,slug:"",subtitle:"",allowComment:!0,id:void 0,images:[],meta:void 0}),B=t=>$(e)(t),e=N(A()),i=m(()=>w.query.id),S=m(()=>w.query.draftId),T=m(()=>!!(i.value&&typeof e.id>"u")),d=q(),l=H(v.Page,{refId:i.value,draftId:S.value,interval:1e4,getData:()=>({title:e.title,text:e.text,images:e.images,meta:e.meta,typeSpecificData:{slug:e.slug,subtitle:e.subtitle,order:e.order}}),onDraftCreated:t=>{d.replace({query:{draftId:t}})},onTitleFallback:t=>{e.title=t}}),c=h(!1);M(async()=>{const t=i.value,o=S.value;if(o){const s=await l.loadDraftById(o);if(s){if(e.title=s.title,e.text=s.text,e.images=s.images||[],e.meta=s.meta,s.typeSpecificData){const n=s.typeSpecificData;e.slug=n.slug||"",e.subtitle=n.subtitle||"",e.order=n.order??0}l.syncMemory(),l.startAutoSave(),c.value=!0;return}}if(t&&typeof t=="string"){const n=(await y.getById(t)).data;B(n);const r=await l.loadDraftByRef(v.Page,t);r?window.dialog.info({title:"检测到未保存的草稿",content:`上次保存时间: ${new Date(r.updated).toLocaleString()}`,negativeText:"使用已发布版本",positiveText:"恢复草稿",onNegativeClick(){l.syncMemory(),l.startAutoSave()},onPositiveClick(){if(e.title=r.title,e.text=r.text,e.images=r.images||[],e.meta=r.meta,r.typeSpecificData){const p=r.typeSpecificData;e.slug=p.slug||e.slug,e.subtitle=p.subtitle||e.subtitle,e.order=p.order??e.order}l.syncMemory(),l.startAutoSave()}}):(l.syncMemory(),l.startAutoSave()),c.value=!0;return}const u=await l.getNewDrafts(v.Page);u.length>0?window.dialog.info({title:"发现未完成的草稿",content:`你有 ${u.length} 个未完成的页面草稿，是否继续编辑？`,negativeText:"创建新草稿",positiveText:"继续编辑",onNegativeClick(){l.startAutoSave()},onPositiveClick(){const s=u[0];d.replace({query:{draftId:s.id}})}}):l.startAutoSave(),c.value=!0});const f=h(!1),g=L(),E=async()=>{const t=()=>{try{if(!e.title||e.title.trim().length==0)throw"标题为空";if(!e.slug)throw"路径为空";return{...ae(e),title:e.title.trim(),slug:e.slug.trim()}}catch(u){throw g.error(u),u}},o=l.draftId.value;if(i.value){if(!Z(i.value))return;const u=i.value;await y.update(u,{...t(),draftId:o}),g.success("修改成功")}else await y.create({...t(),draftId:o}),g.success("发布成功");d.push({name:ee.ListPage,hash:"|publish"})};return I("pt-1"),b(i.value?"修改页面":"新建页面"),V(()=>{P(a(le,{isSaving:l.isSaving,lastSavedTime:l.lastSavedTime},null))}),F(a(D,null,[a(U,{data:e,onHandleYamlParsedMeta:t=>{const{title:o,slug:u,subtitle:s,...n}=t;e.title=o??e.title,e.slug=u??e.slug,e.subtitle=s??e.subtitle,e.meta={...n}}},null),a(W,{iframe:!0,data:e},null),a(x,{icon:a(j,null,null),name:"页面设置",onClick:()=>{f.value=!0}},null),a(x,{icon:a(z,null,null),name:"发布",variant:"primary",onClick:E},null)])),()=>a(D,null,[a(Y,{key:e.id,loading:T.value,autoFocus:i.value?"content":"title",title:e.title,onTitleChange:t=>{e.title=t},titlePlaceholder:"输入标题...",text:e.text,onChange:t=>{e.text=t},subtitleSlot:()=>a("div",{class:"space-y-2"},[a(G,{prefix:`${O}/`,value:e.slug,onChange:t=>{e.slug=t},placeholder:"slug"},null),a("input",{class:["w-full bg-transparent outline-none","text-sm text-neutral-600 dark:text-neutral-400","border-none px-1 py-0.5","placeholder:text-neutral-400 dark:placeholder:text-neutral-500"],placeholder:"输入副标题...",value:e.subtitle,onInput:t=>{e.subtitle=t.target.value}},null)])},null),a(_,{title:"页面设定",disabledItem:["date-picker"],onUpdateShow:t=>{f.value=t},data:e,show:f.value},{default:()=>[a(J,{icon:se},{default:()=>[K("页面选项")]}),a(Q,{label:"页面顺序",description:"用于控制页面在导航中的显示顺序"},{default:()=>[a(X,{class:"w-full",placeholder:"输入排序数字",value:e.order,onUpdateValue:t=>void(e.order=t??0),min:0},null)]})]})])});export{oe as default};
