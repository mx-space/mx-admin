import{d as T,h as k,o as R,a as m,ab as N,a2 as v,r as x,O as M,ac as H,G as $,f as q,i as a,ad as L,ae as V,H as D,af as U,ag as W,Y as b,ah as j,ai as z,aj as Y,ak as G,al as O,j as _,am as J,an as K,ao as Q,a3 as X,a0 as Z,ap as ee}from"./index-BfIRmUdd.js";import{p as y}from"./pages-Cf_hRLI-.js";import{F as te}from"./file-text-DJGdQDPF.js";const se=T(()=>{const h=Z(),{setTitle:S,setHeaderClass:F,setActions:C,setContentPadding:P}=k();P(!1);const A=()=>({text:"",title:"",order:0,slug:"",subtitle:"",allowComment:!0,id:void 0,images:[],meta:void 0}),B=t=>H(e)(t),e=R(A()),i=m(()=>h.query.id),w=m(()=>h.query.draftId),I=m(()=>!!(i.value&&typeof e.id>"u")),d=$(),l=N(v.Page,{refId:i.value,draftId:w.value,interval:1e4,getData:()=>({title:e.title,text:e.text,images:e.images,meta:e.meta,typeSpecificData:{slug:e.slug,subtitle:e.subtitle,order:e.order}}),onDraftCreated:t=>{d.replace({query:{draftId:t}})},onTitleFallback:t=>{e.title=t}}),c=x(!1);M(async()=>{const t=i.value,s=w.value;if(s){const u=await l.loadDraftById(s);if(u){if(e.title=u.title,e.text=u.text,e.images=u.images||[],e.meta=u.meta,u.typeSpecificData){const o=u.typeSpecificData;e.slug=o.slug||"",e.subtitle=o.subtitle||"",e.order=o.order??0}l.syncMemory(),l.startAutoSave(),c.value=!0;return}}if(t&&typeof t=="string"){const o=(await y.getById(t)).data;B(o);const r=await l.loadDraftByRef(v.Page,t);r?window.dialog.info({title:"检测到未保存的草稿",content:`上次保存时间: ${new Date(r.updated).toLocaleString()}`,negativeText:"使用已发布版本",positiveText:"恢复草稿",onNegativeClick(){l.syncMemory(),l.startAutoSave()},onPositiveClick(){if(e.title=r.title,e.text=r.text,e.images=r.images||[],e.meta=r.meta,r.typeSpecificData){const p=r.typeSpecificData;e.slug=p.slug||e.slug,e.subtitle=p.subtitle||e.subtitle,e.order=p.order??e.order}l.syncMemory(),l.startAutoSave()}}):(l.syncMemory(),l.startAutoSave()),c.value=!0;return}const n=await l.getNewDrafts(v.Page);n.length>0?window.dialog.info({title:"发现未完成的草稿",content:`你有 ${n.length} 个未完成的页面草稿，是否继续编辑？`,negativeText:"创建新草稿",positiveText:"继续编辑",onNegativeClick(){l.startAutoSave()},onPositiveClick(){const u=n[0];d.replace({query:{draftId:u.id}})}}):l.startAutoSave(),c.value=!0});const f=x(!1),g=q(),E=async()=>{const t=()=>{try{if(!e.title||e.title.trim().length==0)throw"标题为空";if(!e.slug)throw"路径为空";return{...ee(e),title:e.title.trim(),slug:e.slug.trim()}}catch(s){throw g.error(s),s}};if(i.value){if(!Q(i.value))return;const s=i.value;await y.update(s,t()),g.success("修改成功")}else await y.create(t()),g.success("发布成功");d.push({name:X.ListPage,hash:"|publish"})};return F("pt-1"),S(i.value?"修改页面":"新建页面"),C(a(b,null,[a(L,{data:e,onHandleYamlParsedMeta:t=>{const{title:s,slug:n,subtitle:u,...o}=t;e.title=s??e.title,e.slug=n??e.slug,e.subtitle=u??e.subtitle,e.meta={...o}}},null),a(V,{iframe:!0,data:e},null),a(D,{icon:a(U,null,null),name:"页面设置",onClick:()=>{f.value=!0}},null),a(D,{icon:a(W,null,null),name:"发布",variant:"primary",onClick:E},null)])),()=>a(b,null,[a(j,{key:e.id,loading:I.value,autoFocus:i.value?"content":"title",title:e.title,onTitleChange:t=>{e.title=t},titlePlaceholder:"输入标题...",text:e.text,onChange:t=>{e.text=t},subtitleSlot:()=>a("div",{class:"space-y-2"},[a(z,{prefix:`${Y}/`,value:e.slug,onChange:t=>{e.slug=t},placeholder:"slug"},null),a("input",{class:["w-full bg-transparent outline-none","text-sm text-neutral-600 dark:text-neutral-400","border-none px-1 py-0.5","placeholder:text-neutral-400 dark:placeholder:text-neutral-500"],placeholder:"输入副标题...",value:e.subtitle,onInput:t=>{e.subtitle=t.target.value}},null)])},null),a(G,{title:"页面设定",disabledItem:["date-picker"],onUpdateShow:t=>{f.value=t},data:e,show:f.value},{default:()=>[a(O,{icon:te},{default:()=>[_("页面选项")]}),a(J,{label:"页面顺序",description:"用于控制页面在导航中的显示顺序"},{default:()=>[a(K,{class:"w-full",placeholder:"输入排序数字",value:e.order,onUpdateValue:t=>void(e.order=t??0),min:0},null)]})]})])});export{se as default};
