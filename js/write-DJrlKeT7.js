import{d as E,g as k,n as R,a as g,ab as N,a2 as p,r as S,O as H,ac as M,G as $,w as q,h as a,ad as L,ae as V,H as h,af as U,ag as W,Y as x,ah as z,ai as Y,aj as j,ak as G,al as O,i as _,am as J,an as K,ao as Q,s as v,a3 as X,a0 as Z,ap as tt,aq as et}from"./index-DoEgFLcO.js";import{p as m}from"./pages-BptLnC8M.js";import{F as at}from"./file-text-CxNLTwjh.js";const it=E(()=>{const y=Z(),{setTitle:b,setHeaderClass:D,setActions:I,setContentPadding:F,setHeaderSubtitle:C}=k();F(!1);const P=()=>({text:"",title:"",order:0,slug:"",subtitle:"",allowComment:!0,id:void 0,images:[],meta:void 0}),A=e=>M(t)(e),t=R(P()),r=g(()=>y.query.id),w=g(()=>y.query.draftId),B=g(()=>!!(r.value&&typeof t.id>"u")),n=$(),l=N(p.Page,{refId:r.value,draftId:w.value,interval:1e4,getData:()=>({title:t.title,text:t.text,images:t.images,meta:t.meta,typeSpecificData:{slug:t.slug,subtitle:t.subtitle,order:t.order}}),onDraftCreated:e=>{n.replace({query:{draftId:e}})},onTitleFallback:e=>{t.title=e}}),d=S(!1);H(async()=>{const e=r.value,o=w.value;if(o){const s=await l.loadDraftById(o);if(s){if(t.title=s.title,t.text=s.text,t.images=s.images||[],t.meta=s.meta,s.typeSpecificData){const u=s.typeSpecificData;t.slug=u.slug||"",t.subtitle=u.subtitle||"",t.order=u.order??0}l.syncMemory(),l.startAutoSave(),d.value=!0;return}}if(e&&typeof e=="string"){const s=await m.getById(e);A(s);const u=await l.loadDraftByRef(p.Page,e);u?window.dialog.info({title:"检测到未保存的草稿",content:`上次保存时间: ${new Date(u.updated).toLocaleString()}`,negativeText:"使用已发布版本",positiveText:"恢复草稿",onNegativeClick(){l.syncMemory(),l.startAutoSave()},onPositiveClick(){if(t.title=u.title,t.text=u.text,t.images=u.images||[],t.meta=u.meta,u.typeSpecificData){const f=u.typeSpecificData;t.slug=f.slug||t.slug,t.subtitle=f.subtitle||t.subtitle,t.order=f.order??t.order}l.syncMemory(),l.startAutoSave()}}):(l.syncMemory(),l.startAutoSave()),d.value=!0;return}const i=await l.getNewDrafts(p.Page);i.length>0?window.dialog.info({title:"发现未完成的草稿",content:`你有 ${i.length} 个未完成的页面草稿，是否继续编辑？`,negativeText:"创建新草稿",positiveText:"继续编辑",onNegativeClick(){l.startAutoSave()},onPositiveClick(){const s=i[0];n.replace({query:{draftId:s.id}})}}):l.startAutoSave(),d.value=!0});const c=S(!1),T=async()=>{const e=()=>{try{if(!t.title||t.title.trim().length==0)throw"标题为空";if(!t.slug)throw"路径为空";return{...tt(t),title:t.title.trim(),slug:t.slug.trim()}}catch(i){throw v.error(i),i}},o=l.draftId.value;if(r.value){if(!Q(r.value))return;const i=r.value;await m.update(i,{...e(),draftId:o}),v.success("修改成功")}else await m.create({...e(),draftId:o}),v.success("发布成功");n.push({name:X.ListPage,hash:"|publish"})};return D("pt-1"),b(r.value?"修改页面":"新建页面"),q(()=>{C(a(et,{isSaving:l.isSaving,lastSavedTime:l.lastSavedTime},null))}),I(a(x,null,[a(L,{data:t,onHandleYamlParsedMeta:e=>{const{title:o,slug:i,subtitle:s,...u}=e;t.title=o??t.title,t.slug=i??t.slug,t.subtitle=s??t.subtitle,t.meta={...u}}},null),a(V,{iframe:!0,data:t},null),a(h,{icon:a(U,null,null),name:"页面设置",onClick:()=>{c.value=!0}},null),a(h,{icon:a(W,null,null),name:"发布",variant:"primary",onClick:T},null)])),()=>a(x,null,[a(z,{key:t.id,loading:B.value,autoFocus:r.value?"content":"title",title:t.title,onTitleChange:e=>{t.title=e},titlePlaceholder:"输入标题...",text:t.text,onChange:e=>{t.text=e},subtitleSlot:()=>a("div",{class:"space-y-2"},[a(Y,{prefix:`${j}/`,value:t.slug,onChange:e=>{t.slug=e},placeholder:"slug"},null),a("input",{class:["w-full bg-transparent outline-none","text-sm text-neutral-600 dark:text-neutral-400","border-none px-1 py-0.5","placeholder:text-neutral-400 dark:placeholder:text-neutral-500"],placeholder:"输入副标题...",value:t.subtitle,onInput:e=>{t.subtitle=e.target.value}},null)])},null),a(G,{title:"页面设定",disabledItem:["date-picker"],onUpdateShow:e=>{c.value=e},data:t,show:c.value},{default:()=>[a(O,{icon:at},{default:()=>[_("页面选项")]}),a(J,{label:"页面顺序",description:"用于控制页面在导航中的显示顺序"},{default:()=>[a(K,{class:"w-full",placeholder:"输入排序数字",value:t.order,onUpdateValue:e=>void(t.order=e??0),min:0},null)]})]})])});export{it as default};
